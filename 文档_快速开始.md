# 数据分析 WebUI - 快速开始指南

欢迎使用数据分析 WebUI 项目！这是一个基于大语言模型的智能数据分析系统，可以从 Excel 文件自动生成包含图表、统计信息和 AI 分析见解的 Word 报告。

## 🎯 项目简介

### 核心功能

- 📊 **智能 Excel 分析**：自动识别日期列和数值指标
- 🤖 **自然语言理解**：用中文描述分析需求，系统自动理解
- 🎯 **指标智能匹配**：自动识别相关指标，支持歧义消解
- 📈 **专业报告生成**：生成带图表的 Word 文档，包含统计分析和 AI 见解
- 🔒 **离线部署**：支持 Ollama/vLLM 等内网大模型，数据不出域

### 适用场景

- 🏢 **企业数据分析**：销售数据、生产数据、财务数据分析
- 📊 **定期报告生成**：月报、季报、年报自动生成
- 🔍 **趋势分析**：数据趋势、异常检测、相关性分析
- 📋 **多指标对比**：产量 vs 销量、收入 vs 支出等对比分析

## 🚀 5 分钟快速开始

### 第一步：安装依赖

```bash
# 进入项目目录
cd /home/yy/data_analysis_webui

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

**如果遇到问题：**
```bash
# Ubuntu/Debian 系统：安装 python3-venv
sudo apt install python3.10-venv python3-pip

# 验证 Python 版本（需要 3.9+）
python3 --version
```

### 第二步：配置大模型服务

项目已预配置您的 Ollama 服务，配置文件位于 `api/config.azure.json`：

```json
{
  "Providers": [
    {
      "name": "ollama",
      "api_base_url": "http://172.24.16.1:11434/v1",
      "models": ["qwen3:14b"]
    }
  ],
  "Router": { "default": "ollama,qwen3:14b" }
}
```

**验证 Ollama 服务：**
```bash
# 测试连接
curl http://172.24.16.1:11434/v1/models

# 在 Ollama 机器上检查模型
ollama list | grep qwen3

# 如果模型未安装
ollama pull qwen3:14b
```

### 第三步：生成测试数据

```bash
# 使用项目提供的测试数据生成器
python3 create_test_data.py
```

这将创建一个包含 365 天数据的 `test_data.xlsx` 文件，包含以下字段：
- 日期
- 产量
- 销量
- 库存
- 合格率
- 设备利用率

### 第四步：启动 API 服务

```bash
# 确保虚拟环境已激活
source venv/bin/activate

# 启动服务（前台运行，方便查看日志）
uvicorn src.main:app --host 0.0.0.0 --port 8001
```

您会看到类似的输出：
```
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8001
```

### 第五步：测试分析功能

**打开新的终端窗口**，运行：

```bash
# 确保在项目目录
cd /home/yy/data_analysis_webui

# 激活虚拟环境
source venv/bin/activate

# 运行分析
python skill_build/the_skill_for_this_data_analysis/scripts/call_data_analysis_api.py \
  --excel-path test_data.xlsx \
  --user-prompt "分析最近一年产量和销量的趋势"
```

**预期输出：**
```
📁 File: test_data.xlsx
📝 Prompt: 分析最近一年产量和销量的趋势

💓 Checking service health...
✓ Health check passed

🔍 Matching indicators...
✓ Metrics matched: 产量, 销量

📊 Executing analysis...
✓ Analysis complete

✓ Analysis complete!

📊 Report: /home/yy/data_analysis_webui/data/reports/report_20250301_143025.docx
📈 Metrics: 产量, 销量
📅 Period: 最近一年
📁 Source: Sheet1

打开 Word 文档查看完整图表与详细分析。
```

### 第六步：查看生成的报告

```bash
# 打开报告（Linux）
xdg-open data/reports/report_*.docx

# 或者查看文件信息
ls -lh data/reports/
```

生成的 Word 报告包含：
- 📊 时序图表（带趋势线）
- 📈 统计汇总表（平均值、最大/最小值、中位数、标准差等）
- 📝 AI 生成的分析见解
- 🎯 期初期末对比
- 📉 线性回归趋势分析

## 🎯 使用示例

### 示例 1：基础趋势分析

```bash
python skill_build/the_skill_for_this_data_analysis/scripts/call_data_analysis_api.py \
  --excel-path test_data.xlsx \
  --user-prompt "分析最近一个季度的销量趋势"
```

### 示例 2：多指标对比

```bash
python skill_build/the_skill_for_this_data_analysis/scripts/call_data_analysis_api.py \
  --excel-path test_data.xlsx \
  --user-prompt "分析最近半年产量和销量的相关性，并给出建议"
```

### 示例 3：指定时间范围

```bash
python skill_build/the_skill_for_this_data_analysis/scripts/call_data_analysis_api.py \
  --excel-path test_data.xlsx \
  --user-prompt "分析 2024-01-01 至 2024-06-30 期间的产量变化"
```

### 示例 4：手动指定指标

```bash
python skill_build/the_skill_for_this_data_analysis/scripts/call_data_analysis_api.py \
  --excel-path test_data.xlsx \
  --user-prompt "分析库存周转情况" \
  --select-indicators "库存" "产量"
```

## 🌐 使用 WebUI 界面（推荐）

对于更友好的交互体验，使用 Gradio WebUI：

```bash
# 启动 WebUI
python src/gradio_app.py

# 访问 http://localhost:5600
```

**WebUI 功能：**
- 📁 浏览器上传文件
- 💬 多轮对话分析
- 📄 报告在线预览
- 📝 综合总结生成
- 🔄 迭代修改总结

## 🛠️ 常用命令

### 后台运行服务

```bash
# 启动后台服务
nohup uvicorn src.main:app --host 0.0.0.0 --port 8001 > api.log 2>&1 &

# 查看日志
tail -f api.log

# 停止服务
pkill -f "uvicorn src.main:app"
```

### 检查服务状态

```bash
# 健康检查
curl http://127.0.0.1:8001/healthz

# 查看运行时配置
curl http://127.0.0.1:8001/config/runtime

# 访问 API 文档
# 浏览器打开 http://127.0.0.1:8001/docs
```

## ⚠️ 常见问题

### 问题 1：连接 Ollama 失败

**错误信息**：`Connection refused` 或 `Timeout`

**解决方案**：
```bash
# 1. 检查 Ollama 服务状态
curl http://172.24.16.1:11434/v1/models

# 2. 在 Ollama 机器上检查服务
ollama list

# 3. 确保 Ollama 正在运行
ollama serve
```

### 问题 2：模型未找到

**错误信息**：`model 'qwen3:14b' not found`

**解决方案**：
```bash
# 在 Ollama 机器上拉取模型
ollama pull qwen3:14b
```

### 问题 3：端口被占用

**错误信息**：`Address already in use`

**解决方案**：
```bash
# 查找占用进程
lsof -i :8001

# 终止进程或更换端口
uvicorn src.main:app --host 0.0.0.0 --port 8002
```

### 问题 4：依赖安装失败

**错误信息**：`No module named 'xxx'`

**解决方案**：
```bash
# 更新 pip
pip install --upgrade pip

# 单独安装失败的包
pip install package-name

# 如果遇到编译错误（Ubuntu/Debian）
sudo apt install python3-dev build-essential
```

### 问题 5：Excel 文件解析错误

**错误信息**：`未匹配到有效指标列`

**解决方案**：
```bash
# 使用 --select-indicators 手动指定指标
python skill_build/.../call_data_analysis_api.py \
  --excel-path your_file.xlsx \
  --user-prompt "分析数据" \
  --select-indicators "产量" "销量"
```

## 📖 下一步

- 📚 阅读完整部署指南：`文档_部署指南.md`
- 🎯 查看 API 使用示例：`skill_build/.../EXAMPLES.md`
- 🔧 了解二次开发：`docs/secondary_development.md`
- 🌐 探索 WebUI 功能：启动 `python src/gradio_app.py`

## 💡 提示词编写技巧

### ✅ 好的提示词

- "分析最近一年产量和销量的趋势，比较两者的相关性"
  - 明确指标：产量、销量
  - 明确时间：最近一年
  - 明确目标：比较相关性

- "分析 2024-01 至 2024-06 库存周转情况，找出异常点"
  - 明确时间范围
  - 明确分析重点

### ❌ 需要改进的提示词

- "分析一下数据" （太模糊，无法识别指标）
- "最近怎么样" （缺少时间范围）
- "帮我看看" （没有具体需求）

## 🎉 开始使用

现在您可以：

1. ✅ 准备您的 Excel 数据文件（确保包含日期列）
2. ✅ 使用 API 脚本或 WebUI 进行分析
3. ✅ 在 `data/reports/` 目录查看生成的报告
4. ✅ 根据需要调整配置参数

**第一次使用建议先用小文件测试，确认功能正常后再处理大型数据集。**

## 📞 获取帮助

- 查看故障排查：`文档_部署指南.md` 的故障排查章节
- 查看完整文档：`README.md`
- 查看 API 文档：http://127.0.0.1:8001/docs（服务启动后）

祝使用愉快！ 🚀
